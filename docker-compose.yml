services:
  freva-gpt2-backend:
    image: freva-gpt2-backend
    build:
      context: .
      dockerfile: dockerfiles/chatbot-backend/Dockerfile
      cgroup_manager: cgroupfs
      tags:
        - freva-gpt2-backend:latest
    container_name: freva-gpt2-backend-instance
    hostname: freva-gpt2-backend-instance
    ports:
      - "8502:8502"
    volumes:
      - /work:/work:ro
      - /container/da/freva-gpt-backend-links/logs:/app/logs
      - /container/da/freva-gpt-backend-links/threads:/app/threads
      - /container/da/freva-gpt-backend-links/target:/app/target
      - /home/b/b380001/freva-gpt2-backend/testdata:/data/inputFiles # Deprecated, once used for test data before freva support was added. Now used for debugging. 
      - /container/da/freva-gpt-backend-links/python_pickles:/app/python_pickles
    networks:
      freva-gpt:
        ipv4_address: 10.89.0.2
  ollama:
    image: ollama/ollama
    container_name: ollama-instance
    hostname: ollama-instance
    volumes:
      - /container/da/freva-gpt-ollama-LLMs/.ollama:/root/.ollama
    networks:
      freva-gpt:
        ipv4_address: 10.89.0.3
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  mongodb: # Non-persistent MongoDB instance
    image: mongo:latest
    container_name: mongodb-instance
    hostname: mongodb-instance
    ports:
      - "8503:27017" # Expose MongoDB on port 8503
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${LOCAL_MONGODB_USER:-testing}
      - MONGO_INITDB_ROOT_PASSWORD=${LOCAL_MONGODB_PASSWORD:-testing}
    


networks:
  freva-gpt:
    driver: bridge
    # network_backend: netavark
    ipam:
      config:
        - subnet: 10.89.0.0/16
        - gateway: 10.89.0.1
