services:
  freva-gpt2-backend:
    image: freva-gpt2-backend-${INSTANCE_NAME:?Instance name must be set in the .env file to differentiate between instances}
    build:
      context: .
      dockerfile: dockerfiles/chatbot-backend/Dockerfile
      cgroup_manager: cgroupfs # TODO: This is giving some trouble in development, is it really needed?
      tags:
        - freva-gpt2-backend:${INSTANCE_NAME}
    hostname: freva-gpt2-backend-instance
    ports:
      - "8503:8502"
    volumes:
      - /work:/work:ro
      - /container/da/storage-b380001/freva-gpt-backend-links-${INSTANCE_NAME}/logs:/app/logs
      - /container/da/storage-b380001/freva-gpt-backend-links-${INSTANCE_NAME}/threads:/app/threads
      - /container/da/storage-b380001/freva-gpt-backend-links-${INSTANCE_NAME}/target:/app/target
      - /container/da/storage-b380001/freva-gpt-backend-links-${INSTANCE_NAME}/python_pickles:/app/python_pickles
      - /home/b/b380001/freva-gpt2-backend/testdata:/data/inputFiles # Deprecated, once used for test data before freva support was added. Now used for debugging.
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  ollama:
    image: ollama/ollama
    hostname: ollama-instance
    volumes:
      - /container/da/freva-gpt-ollama-LLMs/.ollama:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
